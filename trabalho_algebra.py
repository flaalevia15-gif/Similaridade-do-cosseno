# -*- coding: utf-8 -*-
"""trabalho algebra

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bD7tRiL2QBMUBjUbQ75bAmWEgpDjMlwN
"""

# 0. Instalando e importando

!pip install kagglehub
import kagglehub
import pandas as pd
from kagglehub import KaggleDatasetAdapter
import numpy as np
import nltk
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
import sys

# --- ETAPA 1: CARREGAMENTO E PREPARA√á√ÉO DA BASE DE DADOS ---

KAGGLE_DATASET = "asaniczka/tmdb-movies-dataset-2023-930k-movies"
FILE_NAME = "TMDB_movie_dataset_v11.csv"
COLUMNS_TO_USE = ['title', 'overview', 'keywords', 'genres', 'tagline', 'vote_average', 'runtime', 'adult', 'release_date', 'original_language']

print(f"Tentando carregar o arquivo '{FILE_NAME}' do dataset '{KAGGLE_DATASET}'...")

try:
    # Usa pandas_kwargs para carregar SOMENTE as colunas necess√°rias
    df = kagglehub.load_dataset(
        KaggleDatasetAdapter.PANDAS,
        KAGGLE_DATASET,
        FILE_NAME,
        pandas_kwargs={'usecols': COLUMNS_TO_USE}
    )
    print("‚úÖ Base de dados carregada com sucesso!")

except Exception as e:
    print(f"\nERRO FATAL ao carregar o dataset do Kaggle: {e}")
    sys.exit()

#corrigindo data pra ano de lan√ßamento
df['release_year'] = pd.to_datetime(df['release_date'], errors='coerce').dt.year
df.dropna(subset=['release_year'], inplace=True)
df['release_year'] = df['release_year'].astype(int)

#filtros
df = df[(df['vote_average'] > 6.0) & (df['runtime'] > 60) & (df['adult'] == False) & (df['release_year'] >= 1995) & (df['original_language'] == 'en')].copy()

# Limpeza e Prepara√ß√£o do Texto
# 1. Trata valores nulos
df.fillna('', inplace=True)

# 2. Cria coluna combinada.
df['features'] = df['overview'] + ' ' + df['keywords'] + ' ' + df['genres'] + ' ' + df['tagline']

# Remove registros onde as features combinadas est√£o vazias ap√≥s a limpeza
df_final = df[df['features'].str.strip() != ''].reset_index(drop=True)

#Dicionario
BASE_DE_FILMES = pd.Series(
    df_final['features'].values,
    index=df_final['title']
).to_dict()

print(f"Base de dados final pronta com {len(BASE_DE_FILMES)} t√≠tulos para an√°lise.")

# --- PARTE DO ALGORITMO DE SIMILARIDADE ---

print("\n==============================================")
print("     üçø IN√çCIO DO SISTEMA DE RECOMENDA√á√ÉO DE FILMES üé¨")

# --- 1. COLETA DE DADOS INTERATIVA (APENAS QUERY) ---

print("\n--- ETAPA 1: DEFINI√á√ÉO DO PERFIL DE PREFER√äNCIA ---")
# MENSAGEM ATUALIZADA para FILMES
print("‚ö† ATEN√á√ÉO: Por favor, cole o texto que descreve os FILMES que voc√™ mais gosta, traduzido para o INGL√äS (Query).")

query_text = input("Query (English): ")

if not query_text.strip():
    print("ERRO: O texto da Query n√£o pode ser vazio.")
    sys.exit()

# --- 2. PREPARA√á√ÉO DO CORPUS ---

# Corpus = [Query] + [Todos os Documentos de Filmes]
corpus = [query_text] + list(BASE_DE_FILMES.values())
nomes_documentos = list(BASE_DE_FILMES.keys())

# --- 3. VETORIZA√á√ÉO (TF-IDF) E PR√â-PROCESSAMENTO ---

print("\n--- ETAPA 2: VETORIZA√á√ÉO TF-IDF ---")

# stop_words='english' e token_pattern=r'\b\w+\b' mantidos para compatibilidade com o dataset em ingl√™s
vectorizer = TfidfVectorizer(
    stop_words='english',
    lowercase=True,
    token_pattern=r'\b\w+\b'
)

tfidf_matrix = vectorizer.fit_transform(corpus)

vetor_q = tfidf_matrix[0]
vetores_d = tfidf_matrix[1:]

# --- 4. CALCULAR √ÇNGULOS (Similaridade de Cosseno) ---

similaridades_array = cosine_similarity(vetor_q, vetores_d)[0]
S_clip = np.clip(similaridades_array, -1.0, 1.0)
angulos_deg = np.degrees(np.arccos(S_clip))


# --- 5. CLASSIFICAR O MAIS SEMELHANTE ---

print("\n--- ETAPA 3: RANKING DE RECOMENDA√á√ÉO ---")

resultados_df = pd.DataFrame({
    'Filme': nomes_documentos,
    'Similaridade (S)': similaridades_array,
    '√Çngulo (Graus)': angulos_deg
})

# Mostrar apenas o TOP 5
resultados_ordenados = resultados_df.sort_values(by='Similaridade (S)', ascending=False).reset_index(drop=True)
resultados_ordenados['Rank'] = resultados_ordenados.index + 1
top_5 = resultados_ordenados.head(5)

print("\nTOP 5 FILMES RECOMENDADOS (do Mais para o Menos Semelhante):\n")
print(top_5[['Rank', 'Filme', 'Similaridade (S)', '√Çngulo (Graus)']]) # Coluna renomeada

print("\nConclus√£o: A Similaridade de Cosseno (S) mede a proximidade sem√¢ntica do t√≠tulo com o seu perfil.")